# 🔧 维修工工单处理功能说明

## 功能概述

### 1️⃣ **自动分配功能**
当维修工点击"开始处理"按钮时，系统会自动将该工单分配给当前登录的维修工。

**触发条件**：
- 工单状态：`Pending`（待处理）
- 操作：点击 `🔧 开始处理` 按钮
- 结果：
  - 工单状态 → `Processing`（处理中）
  - 维修工自动设置为当前登录用户
  - 后台日志显示：`✅ 工单 #X 自动分配给维修工: XXX`

### 2️⃣ **权限控制功能**
维修工只能标记完成自己负责的工单，无法完成其他维修工的工单。

**触发条件**：
- 工单状态：`Processing`（处理中）
- 操作：点击 `✅ 标记完成` 按钮
- 权限检查：
  - ✅ 如果是自己的工单 → 允许完成
  - ❌ 如果是别人的工单 → 返回 403 错误："您只能标记完成自己负责的工单"

---

## 使用场景

### 场景1：维修工接单流程
1. 维修工登录系统（例如：张师傅 / admin123）
2. 查看工单列表
3. 点击某个"待处理"工单的"详情"按钮
4. 在工单详情页，点击 `🔧 开始处理` 按钮
5. **系统自动将该工单分配给张师傅**
6. 工单状态变为"处理中"，维修工显示为"张师傅"

### 场景2：维修工完成工单
1. 张师傅完成维修后，打开该工单详情
2. 点击 `✅ 标记完成` 按钮
3. ✅ 成功：工单状态变为"已完成"

### 场景3：维修工尝试完成他人工单
1. 张师傅尝试标记完成李师傅负责的工单
2. 点击 `✅ 标记完成` 按钮
3. ❌ 失败：提示"您只能标记完成自己负责的工单"

---

## 测试步骤

### 测试1：自动分配
1. 用维修工账号登录（张师傅 / admin123）
2. 找一个"待处理"的工单（例如：张三的"宿舍空调不制冷"）
3. 点击"详情" → 点击"🔧 开始处理"
4. 刷新页面，查看"维修工"字段是否显示为"张师傅"

### 测试2：权限控制
1. 用张师傅登录，开始处理工单A
2. 用李师傅登录，开始处理工单B
3. 用张师傅登录，尝试标记完成工单B
4. 应该看到错误提示："您只能标记完成自己负责的工单"

---

## 技术实现

### 后端逻辑（OrdersController.cs）

```csharp
// 🔧 维修工点击"开始处理"时，自动分配
if (User.IsInRole("Maintainer") && order.Status == "Pending" && dto.Status == "Processing")
{
    if (currentUser != null)
    {
        order.AssignedTo = currentUser.Id;
        Console.WriteLine($"✅ 工单 #{order.Id} 自动分配给维修工: {currentUser.Username}");
    }
}

// 🚫 维修工只能标记完成自己负责的工单
if (User.IsInRole("Maintainer") && dto.Status == "Completed")
{
    if (order.AssignedTo != currentUser?.Id)
    {
        return StatusCode(403, new { message = "您只能标记完成自己负责的工单" });
    }
}
```

---

## 注意事项

1. ⚠️ **管理员不受限制**：管理员可以随意修改任何工单的状态，不受上述规则限制
2. 📋 **学生不能修改状态**：学生只能查看自己的工单，不能修改状态
3. 🔄 **状态流转规则**：Pending → Processing → Completed（单向流转）
