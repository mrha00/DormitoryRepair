# 📷 图片上传功能测试指南

## 🧪 测试环境

- 后端服务: http://localhost:5002
- 前端服务: http://localhost:5173
- 测试账号: 
  - 学生: 张三 / password123
  - 维修工: 王师傅 / admin123
  - 管理员: admin / admin123

---

## 📋 测试清单

### ✅ 阶段一：后端文件服务测试（19:30检查点）

#### 1. 静态文件访问测试
**操作步骤**:
1. 浏览器访问: `http://localhost:5002/uploads/test.jpg`
2. 预期结果: ✅ 能正常显示图片

#### 2. Postman文件上传测试
**请求配置**:
```
方法: POST
URL: http://localhost:5002/api/file/upload
Headers:
  Authorization: Bearer {你的JWT Token}

Body (form-data):
  file: [选择一张图片文件]
```

**获取JWT Token步骤**:
1. 先登录获取Token
```
POST http://localhost:5002/api/auth/login
Content-Type: application/json

{
  "username": "张三",
  "password": "password123"
}
```

2. 从响应中复制token字段的值
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "username": "张三",
  "role": "Student"
}
```

3. 在文件上传请求的Headers中添加:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**成功响应示例**:
```json
{
  "url": "/uploads/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg"
}
```

**错误场景测试**:
1. ❌ 未登录（无Token）
   - 预期: 401 Unauthorized

2. ❌ 文件过大（>5MB）
   - 预期: 400 Bad Request
   - 消息: "文件大小不能超过5MB"

3. ❌ 非图片文件（如.txt）
   - 预期: 400 Bad Request
   - 消息: "仅支持图片格式（jpg、png、gif、webp）"

4. ❌ 不传文件
   - 预期: 400 Bad Request
   - 消息: "文件不能为空"

---

### ✅ 阶段二：前端Canvas压缩测试（20:30检查点）

#### 测试准备
1. 准备一张测试图片（2MB左右）
   - 推荐尺寸: 4000x3000
   - 推荐格式: JPG/PNG

2. 登录前端系统
   - 访问: http://localhost:5173
   - 账号: 张三 / password123

#### 测试步骤
1. **进入创建工单页面**
   - 点击"新建工单"按钮
   - 或访问: http://localhost:5173/orders/create

2. **上传图片**
   - 点击"选择图片"按钮
   - 选择准备好的2MB图片
   - 观察压缩过程

3. **验证压缩结果**
   - ✅ 显示"压缩上传中..."提示
   - ✅ 上传成功后显示预览图
   - ✅ 显示压缩信息：`2000KB → 150KB` (示例)
   - ✅ 压缩后大小 < 200KB
   - ✅ 图片预览清晰，无明显失真

4. **控制台验证**
   - 打开浏览器开发者工具（F12）
   - Console标签应显示:
   ```
   ✅ 图片压缩成功：2048.00KB → 185.23KB
   ```

5. **Network验证**
   - Network标签查看上传请求
   - 找到 `/api/file/upload` 请求
   - Request Payload大小应 < 200KB
   - Response应包含 `{ "url": "/uploads/xxx.jpg" }`

#### 功能测试
1. **移除图片功能**
   - 点击预览图右上角的 × 按钮
   - ✅ 图片预览消失
   - ✅ 显示"已移除图片"提示

2. **重新上传**
   - 再次选择图片
   - ✅ 可以正常上传

3. **不上传图片提交工单**
   - 填写标题、位置、描述
   - 不上传图片
   - ✅ 可以正常提交（图片为可选项）

---

### ✅ 阶段三：工单详情展示测试（21:00检查点）

#### 测试步骤
1. **创建带图片的工单**
   - 填写工单信息:
     ```
     标题: 宿舍灯坏了
     位置: 3号楼301
     描述: 卧室灯不亮了，请尽快维修
     ```
   - 上传一张图片
   - 点击"提交工单"

2. **进入工单列表**
   - ✅ 新工单出现在列表中
   - 记录工单ID（如#123）

3. **进入工单详情**
   - 点击工单卡片或"查看详情"
   - 或访问: http://localhost:5173/orders/123

4. **验证图片展示**
   - ✅ 显示"📷 图片附件"标题
   - ✅ 图片正常加载显示
   - ✅ 图片清晰，无失真
   - ✅ 鼠标悬停有放大效果（轻微缩放）

5. **图片预览功能**
   - 点击图片
   - ✅ 弹出大图预览
   - ✅ 可以关闭预览
   - ✅ 背景蒙层效果正常

6. **移动端测试**
   - 浏览器开启设备模拟（F12 → Toggle device toolbar）
   - 选择iPhone或Android设备
   - ✅ 图片自适应宽度
   - ✅ 预览功能正常

---

## 🎯 性能测试

### 压缩效果测试
**测试多种图片**:

| 原始图片 | 原始大小 | 压缩后大小 | 压缩率 | 画质评价 |
|---------|---------|-----------|--------|---------|
| 风景照 4000x3000 | 2.5MB | 180KB | 93% | ✅ 优秀 |
| 人物照 3000x4000 | 1.8MB | 150KB | 92% | ✅ 优秀 |
| 截图 1920x1080 | 500KB | 95KB | 81% | ✅ 良好 |
| 小图 800x600 | 200KB | 85KB | 57% | ✅ 清晰 |

**评价标准**:
- ✅ 优秀: 压缩率>90%，画质清晰
- ✅ 良好: 压缩率>80%，画质可接受
- ⚠️ 一般: 压缩率>70%，有轻微失真
- ❌ 不佳: 压缩率<70%，失真明显

### 上传速度测试
**网络条件**: 本地环境（无网络延迟）

| 图片大小（压缩后） | 上传耗时 | 评价 |
|-------------------|---------|-----|
| < 100KB | < 0.5秒 | ✅ 极快 |
| 100-200KB | 0.5-1秒 | ✅ 快速 |
| > 200KB | > 1秒 | ⚠️ 需优化 |

---

## 🐛 常见问题排查

### 问题1: 图片上传失败
**症状**: 点击选择图片后，提示"图片处理失败"

**排查步骤**:
1. 检查浏览器Console是否有错误
2. 确认图片格式（仅支持jpg/png/gif/webp）
3. 确认原始图片可正常打开
4. 尝试更换其他图片

**常见原因**:
- 图片文件损坏
- 不支持的图片格式（如.bmp）
- 浏览器不支持Canvas API（太旧的浏览器）

### 问题2: 压缩后仍超过200KB
**症状**: 提示"压缩后图片大小为XXX KB，仍超过200KB限制"

**解决方案**:
- 检查原始图片是否过于复杂（颜色丰富、细节多）
- 尝试调低压缩质量（修改compressImage.js中的0.7参数）
- 或调整最大尺寸限制（修改1200为800）

### 问题3: 图片不显示
**症状**: 工单详情页图片区域空白或显示裂图

**排查步骤**:
1. 检查Network标签图片请求是否404
2. 确认URL格式: `http://localhost:5002/uploads/xxx.jpg`
3. 检查后端`wwwroot/uploads/`目录是否存在该文件
4. 确认后端`Program.cs`已配置`app.UseStaticFiles()`

### 问题4: 401 Unauthorized
**症状**: 上传图片时返回401错误

**解决方案**:
1. 确认已登录（sessionStorage中有token）
2. 检查token是否过期（重新登录）
3. 确认FileController有`[Authorize]`特性

---

## 📊 测试报告模板

### 功能测试报告
```
测试日期: 2025-12-07
测试人员: [您的姓名]
测试环境: Windows / Chrome 120

【阶段一：后端文件服务】
✅ 静态文件访问: 通过
✅ Postman上传测试: 通过
✅ 文件大小限制: 通过
✅ 文件类型验证: 通过
✅ 认证保护: 通过

【阶段二：前端Canvas压缩】
✅ 图片压缩功能: 通过
✅ 压缩效果(2MB→185KB): 通过
✅ 实时预览: 通过
✅ 压缩信息显示: 通过
✅ 移除图片功能: 通过

【阶段三：工单详情展示】
✅ 图片正常显示: 通过
✅ 图片预览功能: 通过
✅ 移动端适配: 通过
✅ 悬停动画效果: 通过

【性能测试】
✅ 2.5MB图片压缩至180KB: 压缩率93%
✅ 上传耗时: 0.8秒
✅ 画质评价: 优秀

【总体评价】
功能完成度: 100%
性能表现: 优秀
用户体验: 优秀
```

---

## 🎬 演示截图清单

### 必备截图（用于检查点）

1. **19:30检查点 - Postman测试**
   - Postman请求配置界面
   - 成功响应JSON截图
   - 显示返回的URL路径

2. **20:30检查点 - 前端压缩**
   - 选择2MB图片界面
   - 压缩过程中的loading状态
   - 压缩成功后的预览图
   - 压缩信息显示（2000KB→150KB）
   - 浏览器Console压缩日志

3. **21:00检查点 - 工单详情**
   - 带图片的工单列表
   - 工单详情页完整截图
   - 图片展示区域特写
   - 图片预览弹窗

---

**🎯 测试目标**: 验证图片上传功能完整可用，达到简历技术亮点要求

**⏰ 预计测试时间**: 30分钟

**✅ 通过标准**: 
- 所有功能测试通过
- 压缩效果达到预期（>90%压缩率）
- 用户体验流畅（上传<1秒）
- 图片质量清晰（无明显失真）

---

*生成时间: 2025-12-07*
*项目: 智慧宿舍报修平台*
